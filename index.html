<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Previewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/theme.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" integrity="sha512-dLxUelApnYxpLt6K2iomGngnQ43cDfOA0gC/qsBbIहिनीEgUOhOtrSFvoGCgaHvyksBB4juhjszKGLbACFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="image_data.js" defer></script>
    <script src="background.js" defer></script>
    <script src="audio.js" defer></script>
    <style>
        /* --- Base Colors & Theme --- */
        body { scroll-behavior: smooth; background-color: #030711; }
        .container { background-color: rgba(61, 5, 68, 0.9); color: #a0aec0; position: relative; z-index: 10; /* backdrop-filter: blur(4px); */ }
        /* H1 styling handled by theme.css .title-glow if applied */
        h2 { color: #f87171; } /* Filter/Folder Section Titles */
        #empty-folder-message { color: #a0aec0; }
        .border-gray-200 { border-color: #000307; }

        /* --- Three.js Background Container --- */
        #threejs-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; overflow: hidden; }
        #threejs-bg canvas { display: block; }

        /* --- Header Layout --- */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to top */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 1rem; /* Space between logo and controls */
            margin-bottom: 1.5rem; /* Space below header */
        }
        /* Removed logo-container */
        .controls-container {
            display: flex;
            flex-direction: column; /* Stack filters and tabs */
            align-items: flex-end; /* Align controls to the right */
            gap: 0.75rem; /* Space between filters and tabs */
            flex-grow: 1; /* Allow controls to take available space */
        }
        #filter-controls, #tab-container, #size-controls { /* Added size controls */
             display: flex;
             flex-wrap: wrap;
             align-items: center;
             gap: 0.5rem 1rem; /* Row and column gap */
             justify-content: flex-end; /* Align items to the right */
             width: 100%; /* Make control groups take full width */
        }
        #tab-container {
             border-bottom: 2px solid #5a0866;
             padding-bottom: 0.5rem; /* Add padding below tabs */
             margin-bottom: 0; /* Remove margin as it's handled by container gap */
        }
        @media (max-width: 768px) {
             .controls-label { display: none; }
             .header-container { justify-content: center; }
             .controls-container { align-items: center; }
             #filter-controls, #tab-container, #size-controls { justify-content: center; }
        }


        /* --- Tab & Filter Styles --- */
        .filter-label, .size-label { color: #cbd5e0; margin-right: 0.25rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem; white-space: nowrap; }
        .filter-select, .size-slider { background-color: rgba(26, 1, 31, 0.8); border: 1px solid #5a0866; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
        .filter-select:focus, .size-slider:focus { outline: none; border-color: #63b3ed; box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.4); }
        .rarity-icon { height: 1em; width: 1em; display: inline-block; vertical-align: middle; margin-left: 0.25rem; }
        .size-slider { padding: 0; height: 0.5rem; cursor: pointer; appearance: none; -webkit-appearance: none; background: #4a044e; border-radius: 9999px; } /* Basic slider style */
        .size-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 1rem; height: 1rem; background: #e70505; border-radius: 50%; cursor: pointer; }
        .size-slider::-moz-range-thumb { width: 1rem; height: 1rem; background: #e70505; border-radius: 50%; cursor: pointer; border: none; }
        .size-value { font-weight: 600; color: #f87171; min-width: 1.5rem; text-align: center; }


        .tab {
            padding: 0.5rem 1rem; margin-bottom: -2px; cursor: pointer;
            border: 2px solid transparent; border-bottom: 2px solid transparent;
            color: #a0aec0; background-color: transparent;
            transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
            --tab-active-border-color: #5a0866; --tab-active-bg-color: rgba(61, 5, 68, 0.5); --tab-active-text-color: #e70505;
            display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap;
        }
        .tab:hover { color: #e2e8f0; border-bottom-color: color-mix(in srgb, var(--tab-active-border-color, #5a0866) 70%, white 30%); }
        .tab.active { color: var(--tab-active-text-color); border-color: var(--tab-active-border-color); border-bottom-color: transparent; background-color: var(--tab-active-bg-color); border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem; font-weight: 600; }
        .tab img[data-broken="true"] { display: none; }


        /* --- Holo Effect CSS --- */
        :root { --color1: rgb(78, 5, 60); --color2: rgb(248, 12, 12); --thumb-gradient-pos-x: 50%; --thumb-gradient-pos-y: 50%; --thumb-sparkle-pos-x: 50%; --thumb-sparkle-pos-y: 50%; --thumb-sparkle-opacity: 0.75; --lb-gradient-pos-x: 50%; --lb-gradient-pos-y: 50%; --lb-sparkle-pos-x: 50%; --lb-sparkle-pos-y: 50%; --lb-sparkle-opacity: 0.75; --click-effect-duration: 0.4s; }
        #item-gallery { perspective: 900px; }
        .thumbnail {
            transform-style: preserve-3d;
            transition: transform 0.25s ease-out, box-shadow 0.25s ease-out;
            will-change: transform, filter, box-shadow;
            position: relative; overflow: hidden; cursor: pointer; outline: none;
            background-color: #1a011f; border: 2px solid #5a0866;
            border-radius: calc(var(--image-aspect-ratio, 0.75) * 5% / 3.5%);
            box-shadow: 0 2px 5px -2px var(--color1), 0 2px 5px -2px var(--color2), 0 15px 15px -10px rgba(0, 0, 0, 0.5);
            isolation: isolate; touch-action: none;
             background-image: linear-gradient(45deg, rgba(45, 55, 72, 0.5) 25%, rgba(74, 85, 104, 0.5) 25%, rgba(74, 85, 104, 0.5) 50%, rgba(45, 55, 72, 0.5) 50%, rgba(45, 55, 72, 0.5) 75%, rgba(74, 85, 104, 0.5) 75%, rgba(74, 85, 104, 0.5) 100%);
             background-size: 40px 40px;
        }
        .thumbnail img { opacity: 0; transition: opacity 0.3s ease-in-out; width: 100%; height: auto; display: block; border-radius: inherit; }
         .thumbnail img.loaded { opacity: 1; }

        .thumbnail.holo-active {
             transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
             transform: scale(1.03);
             box-shadow: -10px -10px 15px -10px var(--color1), 10px 10px 15px -10px var(--color2), 0 0 8px 2px rgba(255,255,255,0.2), 0 35px 25px -15px rgba(0, 0, 0, 0.6);
        }
        .thumbnail.holo-click-active {
            transition: transform var(--click-effect-duration) cubic-bezier(0.165, 0.84, 0.44, 1), box-shadow var(--click-effect-duration) cubic-bezier(0.165, 0.84, 0.44, 1);
            transform: scale(1.05) !important;
            box-shadow: -15px -15px 25px -15px var(--color1), 15px 15px 25px -15px var(--color2), 0 0 15px 5px rgba(255,255,255,0.4), 0 45px 30px -20px rgba(0, 0, 0, 0.7);
        }
        .thumbnail:before, .thumbnail:after { content: ""; position: absolute; left: 0; right: 0; bottom: 0; top: 0; background-repeat: no-repeat; mix-blend-mode: color-dodge; transition: opacity 0.2s ease-out, background-position 0.05s linear, filter 0.2s ease-out; pointer-events: none; border-radius: inherit; }
        .thumbnail:before { background-position: var(--thumb-gradient-pos-x, 50%) var(--thumb-gradient-pos-y, 50%); background-size: 250% 250%; background-image: linear-gradient(115deg, transparent 20%, var(--color1) 45%, var(--color2) 55%, transparent 80%); opacity: 0; filter: brightness(.8) contrast(1.2); z-index: 1; }
        .thumbnail.holo-active:before { opacity: 0.6; transition: opacity 0.1s ease-out, background-position 0.05s linear, filter 0.1s ease-out; }
        .thumbnail.holo-click-active:before { opacity: 0.9 !important; background-position: 50% 50% !important; filter: brightness(1) contrast(1.5); transition: opacity calc(var(--click-effect-duration) * 0.8) ease-out, filter calc(var(--click-effect-duration) * 0.8) ease-out; }
        .thumbnail:after { opacity: var(--thumb-sparkle-opacity, 0); background-image: url("https://assets.codepen.io/13471/sparkles.gif"), linear-gradient(125deg, #ff008420 15%, #fca40020 30%, #ffff0015 40%, #00ff8a10 60%, #00cfff20 70%, #cc4cfa30 85%); background-position: var(--thumb-sparkle-pos-x, 50%) var(--thumb-sparkle-pos-y, 50%); background-size: 180%; background-blend-mode: overlay; z-index: 2; filter: brightness(1.1) contrast(1.1); transition: opacity 0.2s ease-out, background-position 0.05s linear, filter 0.2s ease-out; }
         .thumbnail.holo-active:after { transition: opacity 0.1s ease-out, background-position 0.05s linear, filter 0.1s ease-out; }
        .thumbnail.holo-click-active:after { opacity: 1 !important; background-position: 50% 50% !important; filter: brightness(1.3) contrast(1.3); transition: opacity calc(var(--click-effect-duration) * 0.8) ease-out, filter calc(var(--click-effect-duration) * 0.8) ease-out; }

        /* Lightbox Holo Styles - Keep subtle rotation */
        .lightbox-image-container { perspective: 1500px; transform-style: preserve-3d; position: relative; overflow: hidden; border-radius: 0.25rem; isolation: isolate; transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; will-change: transform, box-shadow; cursor: pointer; }
        .lightbox-image-container.holo-active { transition: transform 0.05s linear, box-shadow 0.1s ease-out; box-shadow: -5px -5px 10px -5px var(--color1), 5px 5px 10px -5px var(--color2), 0 0 5px 1px rgba(255,255,255,0.1); }
        .lightbox-image-container:before, .lightbox-image-container:after { content: ""; position: absolute; left: 0; right: 0; bottom: 0; top: 0; background-repeat: no-repeat; mix-blend-mode: color-dodge; transition: opacity 0.2s ease-out, background-position 0.05s linear, filter 0.2s ease-out; pointer-events: none; border-radius: inherit; }
        .lightbox-image-container:before { background-position: var(--lb-gradient-pos-x, 50%) var(--lb-gradient-pos-y, 50%); background-size: 200% 200%; background-image: linear-gradient(115deg, transparent 20%, var(--color1) 45%, var(--color2) 55%, transparent 80%); opacity: 0; filter: brightness(.9) contrast(1.1); z-index: 3; }
        .lightbox-image-container.holo-active:before { opacity: 0.5; transition: opacity 0.1s ease-out, background-position 0.05s linear, filter 0.1s ease-out; }
        .lightbox-image-container:after { opacity: var(--lb-sparkle-opacity, 0); background-image: url("https://assets.codepen.io/13471/sparkles.gif"), linear-gradient(125deg, #ff008410 15%, #fca40010 30%, #ffff0005 40%, #00ff8a05 60%, #00cfff10 70%, #cc4cfa15 85%); background-position: var(--lb-sparkle-pos-x, 50%) var(--lb-sparkle-pos-y, 50%); background-size: 160%; background-blend-mode: overlay; z-index: 4; filter: brightness(1.2) contrast(1.1); transition: opacity 0.2s ease-out, background-position 0.05s linear, filter 0.2s ease-out; }
         .lightbox-image-container.holo-active:after { transition: opacity 0.1s ease-out, background-position 0.05s linear, filter 0.1s ease-out; }
        /* --- End Holo Styles --- */

        /* Lightbox Size Modifiers */
        .lightbox-content.size-s .lightbox-image-container { max-height: 60vh; max-width: 60vw; }
        .lightbox-content.size-m .lightbox-image-container { max-height: 75vh; max-width: 75vw; }
        .lightbox-content.size-l .lightbox-image-container { max-height: 90vh; max-width: 90vw; } /* Default */


        /* Focus style */
        .thumbnail:focus, .folder-item:focus { box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5); border-color: #63b3ed; background-color: #5a0866; }
        /* Selected style */
        .thumbnail.selected-inline { border-color: #63b3ed; box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5); }

        /* Folder Item Styling */
        .folder-item { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 8rem; padding: 0.5rem; border: 2px solid #5a0866; border-radius: 5% / 3.5%; transition: transform 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.15s ease-in-out; cursor: pointer; outline: none; overflow: hidden; background-color: #1a011f; color: #a0aec0; }
        .folder-item:hover { transform: scale(1.03); background-color: #5a0866; }
        .folder-item i { color: #fbbf24; margin-bottom: 0.25rem; }
        .folder-item span { line-height: 1.2; color: #e2e8f0; }

        /* Lightbox Styling */
        .lightbox-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; padding: 1rem; }
        .lightbox-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .lightbox-content { position: relative; background-color: #1a011f; padding: 1rem; border-radius: 0.5rem; /* Max size set by size class */ display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); transition: max-width 0.3s ease, max-height 0.3s ease; }
        .lightbox-image { max-width: 100%; max-height: 100%; object-fit: contain; display: block; border-radius: 0.25rem; position: relative; z-index: 1; }
        .lightbox-controls { position: absolute; top: 50%; left: 0; right: 0; display: flex; justify-content: space-between; transform: translateY(-50%); padding: 0 0.5rem; pointer-events: none; z-index: 10; }
        .lightbox-controls button { background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; pointer-events: all; }
        .lightbox-controls button:hover { background-color: rgba(0, 0, 0, 0.9); }
        .lightbox-close { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; width: 2rem; height: 2rem; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; pointer-events: all; z-index: 10; }
        .lightbox-close:hover { background-color: rgba(0, 0, 0, 0.9); }
        .lightbox-filename { color: #a0aec0; font-size: 0.875rem; margin-top: 0.5rem; text-align: center; word-break: break-all; position: relative; z-index: 5; }

        /* Loading Spinner */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: #fff; width: 3rem; height: 3rem; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        .hidden { display: none; }

        /* Load More Button */
        #load-more-button { display: block; margin: 1.5rem auto 0; padding: 0.6rem 1.5rem; background: linear-gradient(to bottom right, #5a0866, #3d0544); color: #e2e8f0; border: 2px solid #7e22ce; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        #load-more-button:hover { background: linear-gradient(to bottom right, #7e22ce, #5a0866); transform: translateY(-1px); box-shadow: 0 6px 15px rgba(0,0,0,0.5); }
        #load-more-button:active { transform: translateY(0px); box-shadow: 0 3px 8px rgba(0,0,0,0.4); }
        #load-more-button:disabled { opacity: 0.5; cursor: not-allowed; background: #3d0544; box-shadow: none; transform: none; }

        /* Audio Styles are now in theme.css */
        /* Footer Style is now in theme.css */

    </style>
</head>
<body class="font-sans p-4 md:p-8">

    <div id="threejs-bg"></div>

    <div class="container mx-auto max-w-7xl rounded-lg shadow-lg p-6">

        <div class="header-container">
             <div class="logo-container">
                  <h1 class="title-glow">Pocket Previewer</h1>
             </div>
             <div class="controls-container">
                  <div id="filter-controls" class="flex flex-wrap items-center gap-y-2">
                       <h2 class="text-base font-semibold mr-2 text-gray-300 controls-label">Filters:</h2>
                       <div>
                            <label for="type-filter" class="filter-label">Type:</label>
                            <select id="type-filter" name="type-filter" class="filter-select">
                                 <option value="all">All Types</option>
                            </select>
                       </div>
                       <div>
                            <label for="rarity-filter" class="filter-label">
                                 Rarity:
                                 <img id="rarity-icon-display" src="" alt="" class="rarity-icon hidden">
                            </label>
                            <select id="rarity-filter" name="rarity-filter" class="filter-select">
                                 <option value="all">All Rarities</option>
                            </select>
                       </div>
                  </div>
                   <div id="size-controls" class="flex flex-wrap items-center gap-y-2">
                       <h2 class="text-base font-semibold mr-2 text-gray-300 controls-label">Sizes:</h2>
                        <div>
                            <label for="thumb-size-slider" class="size-label">Thumbnails:</label>
                            <input type="range" id="thumb-size-slider" name="thumb-size" min="0" max="2" step="1" value="1" class="size-slider w-20 align-middle">
                            <span id="thumb-size-value" class="size-value ml-2">M</span>
                       </div>
                       <div>
                            <label for="popup-size-slider" class="size-label">Popup:</label>
                            <input type="range" id="popup-size-slider" name="popup-size" min="0" max="2" step="1" value="2" class="size-slider w-20 align-middle">
                            <span id="popup-size-value" class="size-value ml-2">L</span>
                       </div>
                  </div>
                  <div id="tab-container" class="flex flex-wrap gap-x-2 gap-y-2 items-center">
                       <h2 class="text-base font-semibold mr-2 text-gray-300 controls-label">Folder:</h2>
                       {/* Tabs generated here */}
                  </div>
             </div>
        </div>


        <div class="border-t pt-4 border-black">
            <div id="item-gallery" class="mt-6 grid gap-4 items-start" role="grid">
            </div>
            <button id="load-more-button" class="hidden">Load More</button>
            <p id="empty-folder-message" class="text-center mt-4 hidden">No images match the current filters.</p>
        </div>

         <footer class="footer">
             <img src="resources/tcg-pocket-logo.png" alt="" onerror="this.style.display='none'">
             This is a fan site for testing image loading and previewing elements.
             <img src="resources/tcg-pocket-logo.png" alt="" onerror="this.style.display='none'">
        </footer>

    </div>

    <div id="lightbox-overlay" class="lightbox-overlay" role="dialog" aria-modal="true" aria-hidden="true">
         <div class="lightbox-content size-l"> {/* Default to large size */}
            <button id="lightbox-close" class="lightbox-close" aria-label="Close image viewer"><i class="fas fa-times"></i></button>
            <div id="lightbox-image-container" class="lightbox-image-container">
                <div id="lightbox-spinner" class="spinner hidden"></div>
                <img id="lightbox-image" class="lightbox-image" src="" alt="Full size image preview">
            </div>
            <p id="lightbox-filename" class="lightbox-filename"></p>
            <div class="lightbox-controls">
                <button id="lightbox-prev" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
                <button id="lightbox-next" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <div id="audio-prompt" style="display: block;">Click anywhere to enable audio</div>

    <div id="audio-control-container" style="display: none;"> <span id="song-name"></span>
         <button id="play-pause-button" class="audio-button" aria-label="Play/Pause"><i class="fas fa-play"></i></button>
         <button id="next-song-button" class="audio-button" aria-label="Next Song"><i class="fas fa-forward-step"></i></button>
         <div id="mute-button" class="audio-button" aria-label="Mute/Unmute">
              <i class="fas fa-volume-high"></i> <div id="volume-container">
                   <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.6"> </div>
         </div>
    </div>


    <script>
        // --- Configuration ---
        const placeholderUrl = "https://placehold.co/100x80/cccccc/ffffff.png?text=Error";
        const mainPlaceholderUrl = "https://placehold.co/600x400/cccccc/ffffff.png?text=Loading...";
        const CLICK_EFFECT_DURATION_MS = 400;
        const RESOURCE_FOLDER = 'resources';
        const ICON_SUFFIX = '-icon';
        const IMAGE_EXT = '.png';
        const IMAGES_PER_LOAD = 21; // Default images per load
        const SIZE_MAP = ['S', 'M', 'L']; // Map slider values to labels
        const THUMB_GRID_CLASSES = [ // Tailwind classes per size [S, M, L]
             'grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 xl:grid-cols-8', // Small
             'grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7', // Medium (Default)
             'grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6'  // Large
        ];
        const POPUP_SIZE_CLASSES = ['size-s', 'size-m', 'size-l']; // CSS classes for lightbox size

        // --- Elements ---
        const itemGallery = document.getElementById('item-gallery');
        const tabContainer = document.getElementById('tab-container');
        const typeFilterSelect = document.getElementById('type-filter');
        const rarityFilterSelect = document.getElementById('rarity-filter');
        const rarityIconDisplay = document.getElementById('rarity-icon-display');
        const emptyFolderMessage = document.getElementById('empty-folder-message');
        const loadMoreButton = document.getElementById('load-more-button');
        const lightboxOverlay = document.getElementById('lightbox-overlay');
        const lightboxContent = lightboxOverlay.querySelector('.lightbox-content');
        const lightboxImageContainer = document.getElementById('lightbox-image-container');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxCloseBtn = document.getElementById('lightbox-close');
        const lightboxPrevBtn = document.getElementById('lightbox-prev');
        const lightboxNextBtn = document.getElementById('lightbox-next');
        const lightboxFilename = document.getElementById('lightbox-filename');
        const lightboxSpinner = document.getElementById('lightbox-spinner');
        const thumbSizeSlider = document.getElementById('thumb-size-slider');
        const thumbSizeValue = document.getElementById('thumb-size-value');
        const popupSizeSlider = document.getElementById('popup-size-slider');
        const popupSizeValue = document.getElementById('popup-size-value');
        // Audio Elements are handled in audio.js

        // --- State ---
        let currentFolderObject = null;
        let currentImageFiles = []; // Images for the lightbox sequence (currently visible batch)
        let currentImageIndex = -1;
        let focusableElements = [];
        let currentFocusIndex = 0;
        let activeHoloTimeout = null;
        let activeLightboxHoloTimeout = null;
        let currentlyDisplayedImages = []; // FULL list of images matching current filters/tab
        let currentlyRenderedCount = 0;
        let currentTypeFilter = 'all';
        let currentRarityFilter = 'all';
        let baseImageSet = [];
        let currentThumbSizeIndex = 1; // Default M (index 1)
        let currentPopupSizeIndex = 2; // Default L (index 2)
        let lastScrollY = 0; // To store scroll position

        // --- Data loaded from image_data.js ---
        let rootImageStructure = null;
        let filterConfig = null;

        // --- Functions ---

        /** Finds a folder object by path */
        function findFolderByPath(pathString, startNode = rootImageStructure) {
             if (!startNode || typeof startNode !== 'object') { console.error("findFolderByPath: startNode is invalid."); return null; }
             if (!pathString || pathString === '.' || pathString === startNode.path) { return startNode; }
             const parts = pathString.split('/').filter(p => p);
             const rootName = startNode.path ? startNode.path.split('/').filter(p => p)[0] : null;
             let currentNode = startNode;
             const searchParts = (rootName && parts[0] === rootName) ? parts.slice(1) : parts;
             for (const part of searchParts) {
                  if (!currentNode.children || !Array.isArray(currentNode.children)) { console.error(`Node '${currentNode.name}' has no children.`); return null; }
                 const nextNode = currentNode.children.find(child => child.type === 'folder' && child.name === part);
                 if (!nextNode) { console.error(`Could not find folder part: ${part} in path ${pathString}`); return null; }
                 currentNode = nextNode;
             }
             return currentNode;
         }

        /** Recursively collects all image file objects from a node */
        function getAllImageFilesRecursive(node) {
            let files = [];
            if (!node || !node.children) return files;
            node.children.forEach(child => {
                if (child.type === 'file') { files.push(child); }
                else if (child.type === 'folder') { files = files.concat(getAllImageFilesRecursive(child)); }
            });
            // files.sort((a, b) => a.path.localeCompare(b.path)); // Optional sort
            return files;
        }

        /** Opens the lightbox */
        function openLightbox(imagePath) {
            lastScrollY = window.scrollY; // Store scroll position
            console.log("Stored scrollY:", lastScrollY);
            // Use currentlyDisplayedImages (the full filtered list) for finding index
            const index = currentlyDisplayedImages.findIndex(img => img.path === imagePath);
            if (index === -1) { console.error("Image path not found for lightbox:", imagePath); return; }

            // Set lightbox sequence to the full filtered list
            currentImageFiles = currentlyDisplayedImages;
            currentImageIndex = index;

            const imageFile = currentImageFiles[currentImageIndex];
            resetLightboxHoloEffect();
            lightboxSpinner.classList.remove('hidden'); lightboxImage.classList.add('hidden');
            lightboxImageContainer.classList.remove('holo-active'); lightboxImage.src = '';
            lightboxImage.onload = () => { lightboxSpinner.classList.add('hidden'); lightboxImage.classList.remove('hidden'); };
            lightboxImage.onerror = () => { console.error("Error loading image in lightbox:", imageFile.path); lightboxSpinner.classList.add('hidden'); lightboxImage.classList.remove('hidden'); lightboxImage.src = mainPlaceholderUrl; lightboxImage.alt = `Error loading ${imageFile.name}`; lightboxFilename.textContent = `Error loading: ${imageFile.name}`; };
            lightboxImage.src = imageFile.path; lightboxImage.alt = `Preview of ${imageFile.name}`;
            lightboxFilename.textContent = imageFile.name;
            // Apply popup size class
            lightboxContent.classList.remove(...POPUP_SIZE_CLASSES); // Remove old size classes
            lightboxContent.classList.add(POPUP_SIZE_CLASSES[currentPopupSizeIndex]); // Add current size class
            lightboxOverlay.classList.add('visible');
            lightboxOverlay.setAttribute('aria-hidden', 'false');
            lightboxCloseBtn.focus();
            updateLightboxControls(); highlightThumbnail(imageFile.path);
            // Prevent body scroll while lightbox is open
             document.body.style.overflow = 'hidden';
         }

        /** Closes the lightbox */
        function closeLightbox() {
             lightboxOverlay.classList.remove('visible');
            lightboxOverlay.setAttribute('aria-hidden', 'true');
             document.body.style.overflow = ''; // Restore body scroll
            currentImageIndex = -1;
             resetLightboxHoloEffect();
             // Restore scroll position
             console.log("Attempting to restore scrollY to:", lastScrollY);
             requestAnimationFrame(() => {
                 window.scrollTo(0, lastScrollY);
                 const opener = itemGallery.querySelector(`.thumbnail[data-path='${currentImageFiles[currentImageIndex]?.path}']`) || (focusableElements[currentFocusIndex] ? focusableElements[currentFocusIndex] : null);
                 if (opener) { setTimeout(() => opener.focus(), 0); }
             });
             unhighlightAllThumbnails();
         }
        /** Shows the next image in the lightbox */
        function showNextImage() { if (currentImageIndex < currentImageFiles.length - 1) { openLightbox(currentImageFiles[currentImageIndex + 1].path); } }
        /** Shows the previous image in the lightbox */
        function showPrevImage() { if (currentImageIndex > 0) { openLightbox(currentImageFiles[currentImageIndex - 1].path); } }
        /** Updates lightbox controls */
        function updateLightboxControls() {
             lightboxPrevBtn.disabled = currentImageIndex <= 0;
            lightboxNextBtn.disabled = currentImageIndex >= currentImageFiles.length - 1;
            lightboxPrevBtn.classList.toggle('opacity-50', lightboxPrevBtn.disabled);
            lightboxPrevBtn.classList.toggle('cursor-not-allowed', lightboxPrevBtn.disabled);
            lightboxNextBtn.classList.toggle('opacity-50', lightboxNextBtn.disabled);
            lightboxNextBtn.classList.toggle('cursor-not-allowed', lightboxNextBtn.disabled);
         }
        /** Highlights the thumbnail */
        function highlightThumbnail(imagePath) {
             unhighlightAllThumbnails();
             const thumbContainer = itemGallery.querySelector(`.thumbnail[data-path='${imagePath}']`);
             if (thumbContainer) { thumbContainer.classList.add('selected-inline'); }
         }
        /** Removes highlight from all thumbnails */
        function unhighlightAllThumbnails() { itemGallery.querySelectorAll('.thumbnail.selected-inline').forEach(el => { el.classList.remove('selected-inline'); }); }

        /** Appends a batch of images to the gallery */
        function appendImagesToGallery(imagesToAppend) {
             console.log(`[appendImagesToGallery] Appending ${imagesToAppend.length} images.`);
             imagesToAppend.forEach(image => {
                const thumbnailContainer = document.createElement('div');
                thumbnailContainer.className = 'thumbnail';
                thumbnailContainer.setAttribute('tabindex', '0'); thumbnailContainer.setAttribute('role', 'button');
                thumbnailContainer.dataset.path = image.path; thumbnailContainer.setAttribute('aria-label', `Image: ${image.name}`);

                const img = document.createElement('img');
                img.src = image.path; img.alt = `Thumbnail ${image.name}`;
                img.className = 'w-full h-auto block pointer-events-none';
                img.loading = 'lazy';

                img.onload = () => {
                     img.classList.add('loaded');
                     if (img.naturalWidth && img.naturalHeight) {
                          const aspectRatio = img.naturalWidth / img.naturalHeight;
                          const borderRadiusMultiplier = Math.min(Math.max(aspectRatio, 0.5), 1.5);
                          thumbnailContainer.style.setProperty('--image-aspect-ratio', aspectRatio);
                          thumbnailContainer.style.borderRadius = `${5 * borderRadiusMultiplier}% / ${3.5 / borderRadiusMultiplier}%`;
                     } else {
                           thumbnailContainer.style.borderRadius = `${5 * 0.75}% / ${3.5 / 0.75}%`;
                     }
                 };
                img.onerror = function() {
                     const container = this.closest('.thumbnail');
                    if (container) {
                         container.innerHTML = `<div class="flex items-center justify-center bg-gray-600 aspect-video text-gray-400 rounded-md"><i class="fas fa-image fa-lg" title="Error loading ${image.name}"></i></div>`;
                        container.style.cursor = 'not-allowed';
                        container.removeAttribute('tabindex'); container.removeAttribute('role');
                        container.removeAttribute('data-path'); container.style.pointerEvents = 'none';
                        console.warn(`Thumbnail failed to load: ${image.path}`);
                        focusableElements = Array.from(itemGallery.querySelectorAll('.thumbnail[tabindex="0"]'));
                    }
                 };

                const activateThumbnail = (eventSourceElement) => {
                     const internalImg = eventSourceElement.querySelector('img');
                    if (internalImg && !eventSourceElement.querySelector('.bg-gray-600') && !eventSourceElement.classList.contains('holo-click-active')) {
                        eventSourceElement.classList.add('holo-click-active');
                        resetHoloEffect(eventSourceElement, false);
                        setTimeout(() => {
                            eventSourceElement.classList.remove('holo-click-active');
                            currentImageFiles = currentlyDisplayedImages; // Ensure lightbox uses full list
                            if (!lightboxOverlay.classList.contains('visible')) { openLightbox(image.path); }
                        }, CLICK_EFFECT_DURATION_MS);
                    }
                 };
                thumbnailContainer.addEventListener('click', () => activateThumbnail(thumbnailContainer));
                thumbnailContainer.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { activateThumbnail(thumbnailContainer); } });

                itemGallery.appendChild(thumbnailContainer);
                focusableElements.push(thumbnailContainer); // Add *after* appending
            });
        }


        /** Renders the next batch of images */
        function renderNextBatch() {
             console.log(`[renderNextBatch] Current count: ${currentlyRenderedCount}, Total available: ${currentlyDisplayedImages.length}`);
             const startIndex = currentlyRenderedCount;
             const endIndex = Math.min(startIndex + IMAGES_PER_LOAD, currentlyDisplayedImages.length);
             const batch = currentlyDisplayedImages.slice(startIndex, endIndex);

             if (startIndex === 0) { // Only clear if it's the first batch for this view
                  console.log("[renderNextBatch] Rendering initial batch, clearing gallery.");
                  itemGallery.innerHTML = '';
                  focusableElements = [];
             }

              if (batch.length === 0 && startIndex === 0) {
                  console.log("[renderNextBatch] No images match current filters.");
                  emptyFolderMessage.classList.remove('hidden');
                  loadMoreButton.classList.add('hidden');
                  return;
             } else {
                  emptyFolderMessage.classList.add('hidden');
             }

             appendImagesToGallery(batch);
             currentlyRenderedCount = endIndex;

             if (currentlyRenderedCount >= currentlyDisplayedImages.length) {
                  loadMoreButton.classList.add('hidden');
                  console.log("[renderNextBatch] All images loaded.");
             } else {
                  loadMoreButton.classList.remove('hidden');
                  console.log(`[renderNextBatch] ${currentlyDisplayedImages.length - currentlyRenderedCount} images remaining.`);
             }
        }


        /** Applies current filters and triggers rendering the first batch */
        function applyFiltersAndRender() {
             console.log(`[applyFiltersAndRender] Applying filters: Type='${currentTypeFilter}', Rarity='${currentRarityFilter}'`);
             console.log(`[applyFiltersAndRender] Base image set size: ${baseImageSet.length}`);
             let filteredImages = [...baseImageSet];

             if (currentTypeFilter !== 'all') {
                  filteredImages = filteredImages.filter(img => img.cardType === currentTypeFilter);
             }
             if (currentRarityFilter !== 'all') {
                  filteredImages = filteredImages.filter(img => img.cardRarity === currentRarityFilter);
             }

             currentlyDisplayedImages = filteredImages; // Store the FULL filtered list
             currentlyRenderedCount = 0; // Reset rendered count for new filter/tab
             console.log(`[applyFiltersAndRender] Total filtered images: ${currentlyDisplayedImages.length}`);

             // Update Rarity Icon Display
             if (rarityIconDisplay) {
                  if (currentRarityFilter !== 'all') {
                       const iconFileName = `${currentRarityFilter.replace(/\s+/g, '')}${ICON_SUFFIX}${IMAGE_EXT}`;
                       const iconPath = `${RESOURCE_FOLDER}/${iconFileName}`;
                       rarityIconDisplay.src = iconPath;
                       rarityIconDisplay.alt = `${currentRarityFilter} icon`;
                       rarityIconDisplay.classList.remove('hidden');
                       rarityIconDisplay.onerror = function() { this.classList.add('hidden'); };
                  } else {
                       rarityIconDisplay.classList.add('hidden'); rarityIconDisplay.src = ''; rarityIconDisplay.alt = '';
                  }
             }

             renderNextBatch(); // Render the first batch (this will clear the gallery)
        }

        /** Populates filter dropdowns */
        function populateFilters() {
             if (!filterConfig || !typeFilterSelect || !rarityFilterSelect) { console.error("[populateFilters] Cannot populate: Missing config or select elements."); return; }
             console.log("[populateFilters] Config:", filterConfig);

             // Type Filter
             while (typeFilterSelect.options.length > 1) { typeFilterSelect.remove(1); }
             (filterConfig.typeOrder || []).forEach(type => {
                  const option = document.createElement('option'); option.value = type; option.textContent = type; typeFilterSelect.appendChild(option);
             });

             // Rarity Filter
             while (rarityFilterSelect.options.length > 1) { rarityFilterSelect.remove(1); }
             (filterConfig.rarityOrder || []).forEach(rarity => {
                  const option = document.createElement('option'); option.value = rarity; option.textContent = rarity; rarityFilterSelect.appendChild(option);
             });
        }


        /** Renders the navigation tabs using the defined folder order and colors */
        function renderTabs() {
            if (!tabContainer || !rootImageStructure || !filterConfig || !filterConfig.folderOrder || !filterConfig.folderColors) {
                 console.error("[renderTabs] Missing elements or config.");
                 const label = tabContainer.querySelector('h2');
                 tabContainer.innerHTML = ''; if (label) tabContainer.appendChild(label); return;
            }
            const label = tabContainer.querySelector('h2');
            tabContainer.innerHTML = ''; if (label) tabContainer.appendChild(label);

            const availableFolders = rootImageStructure.children.filter(item => item.type === 'folder');

            // --- Create "All" tab ---
            const allTab = document.createElement('button');
            allTab.className = 'tab active'; allTab.dataset.folderPath = 'all';
            const allColor = filterConfig.folderColors['all'] || filterConfig.folderColors['default'] || '#6B7280';
            allTab.style.setProperty('--tab-active-border-color', allColor);
            allTab.style.setProperty('--tab-active-bg-color', hexToRgba(allColor, 0.3));
            allTab.style.setProperty('--tab-active-text-color', lightenHexColor(allColor, 0.8));
            const allTextSpan = document.createElement('span'); allTextSpan.textContent = 'All'; allTab.appendChild(allTextSpan);
            tabContainer.appendChild(allTab);

            // --- Sort and Create Folder Tabs ---
            const sortedFolders = availableFolders.sort((a, b) => {
                const indexA = filterConfig.folderOrder.indexOf(a.name);
                const indexB = filterConfig.folderOrder.indexOf(b.name);
                const effectiveIndexA = indexA === -1 ? Infinity : indexA;
                const effectiveIndexB = indexB === -1 ? Infinity : indexB;
                if (effectiveIndexA !== effectiveIndexB) return effectiveIndexA - effectiveIndexB;
                return a.name.localeCompare(b.name);
             });

            sortedFolders.forEach(folder => {
                const folderTab = document.createElement('button');
                folderTab.className = 'tab'; folderTab.dataset.folderPath = folder.path;
                const tabColor = filterConfig.folderColors[folder.name] || filterConfig.folderColors['default'] || '#6B7280';
                folderTab.style.setProperty('--tab-active-border-color', tabColor);
                folderTab.style.setProperty('--tab-active-bg-color', hexToRgba(tabColor, 0.3));
                folderTab.style.setProperty('--tab-active-text-color', lightenHexColor(tabColor, 0.8));
                const textSpan = document.createElement('span'); textSpan.textContent = folder.name; folderTab.appendChild(textSpan);
                tabContainer.appendChild(folderTab);
            });

            // --- Add event listener ---
            if (!tabContainer.dataset.listenerAttached) {
                 tabContainer.addEventListener('click', (e) => {
                      const clickedTab = e.target.closest('.tab');
                      if (clickedTab) {
                           const path = clickedTab.dataset.folderPath;
                           tabContainer.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                           clickedTab.classList.add('active');

                           if (path === 'all') {
                                currentFolderObject = { path: 'all', type: 'all' };
                                baseImageSet = getAllImageFilesRecursive(rootImageStructure);
                           } else {
                                const targetFolder = findFolderByPath(path, rootImageStructure);
                                if (targetFolder) {
                                     currentFolderObject = targetFolder;
                                     baseImageSet = targetFolder.children.filter(item => item.type === 'file');
                                } else {
                                     console.error("[Tab Click] Could not find folder for path:", path);
                                     displayError(`Error: Could not find folder '${path}'.`);
                                     baseImageSet = [];
                                }
                           }
                           applyFiltersAndRender(); // Re-apply filters and render first batch
                      }
                 });
                 tabContainer.dataset.listenerAttached = 'true';
            }
        }

        /** Displays an error message */
        function displayError(message) {
             itemGallery.innerHTML = `<p class="text-red-500 col-span-full p-4 bg-red-100 border border-red-400 rounded">${message}</p>`;
             emptyFolderMessage.classList.add('hidden');
             loadMoreButton.classList.add('hidden');
         }
        /** Handles keyboard navigation within the gallery */
        function handleGalleryKeyDown(e) {
            if (focusableElements.length === 0 || lightboxOverlay.classList.contains('visible')) return;
              const gridElement = document.getElementById('item-gallery');
              const gridStyle = window.getComputedStyle(gridElement);
              const gridCols = gridStyle.getPropertyValue('grid-template-columns').split(' ').length;
             let nextFocusIndex = currentFocusIndex;
             switch (e.key) {
                 case 'ArrowRight': nextFocusIndex = (currentFocusIndex + 1) % focusableElements.length; break;
                 case 'ArrowLeft': nextFocusIndex = (currentFocusIndex - 1 + focusableElements.length) % focusableElements.length; break;
                 case 'ArrowDown': nextFocusIndex = Math.min(currentFocusIndex + gridCols, focusableElements.length - 1); break;
                 case 'ArrowUp': nextFocusIndex = Math.max(currentFocusIndex - gridCols, 0); break;
                  case 'Home': nextFocusIndex = 0; break;
                  case 'End': nextFocusIndex = focusableElements.length - 1; break;
                 default: return;
             }
             if (nextFocusIndex !== currentFocusIndex && nextFocusIndex < focusableElements.length) {
                 e.preventDefault();
                 currentFocusIndex = nextFocusIndex;
                 focusableElements[currentFocusIndex].focus();
             }
         }
        /** Handles keyboard events when the lightbox is open */
        function handleLightboxKeyDown(e) {
              if (!lightboxOverlay.classList.contains('visible')) return;
             switch (e.key) {
                 case 'Escape': closeLightbox(); break;
                 case 'ArrowRight': if (!lightboxNextBtn.disabled) showNextImage(); break;
                 case 'ArrowLeft': if (!lightboxPrevBtn.disabled) showPrevImage(); break;
             }
         }

        // --- Thumbnail Holo Effect Logic ---
        function applyHoloListeners(containerSelector) {
             const container = document.querySelector(containerSelector);
            if (!container) return;
            container.addEventListener('mousemove', handleHoloMove);
            container.addEventListener('touchmove', handleHoloMove, { passive: false });
            container.addEventListener('mouseout', handleHoloEnd);
            container.addEventListener('touchend', handleHoloEnd);
            container.addEventListener('touchcancel', handleHoloEnd);
         }
        function handleHoloMove(e) {
             const target = e.target.closest('.thumbnail');
            if (!target || target.classList.contains('holo-click-active')) {
                 const lastActive = itemGallery.querySelector('.thumbnail.holo-active');
                 if(lastActive && !lastActive.classList.contains('holo-click-active')) resetHoloEffect(lastActive);
                 return;
            }
            const currentlyActive = itemGallery.querySelector('.thumbnail.holo-active');
            if(currentlyActive && currentlyActive !== target) { resetHoloEffect(currentlyActive); }
            const rect = target.getBoundingClientRect(); let clientX, clientY;
            if (e.type === "touchmove") { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; e.preventDefault(); }
            else { clientX = e.clientX; clientY = e.clientY; }
            const offsetX = clientX - rect.left; const offsetY = clientY - rect.top;
            const w = target.offsetWidth; const h = target.offsetHeight;
            const px = Math.abs(Math.floor(100 / w * offsetX) - 100); const py = Math.abs(Math.floor(100 / h * offsetY) - 100);
            const pa = (50 - px) + (50 - py);
            const lp = (50 + (px - 50) / 1.5); const tp = (50 + (py - 50) / 1.5);
            const px_spark = (50 + (px - 50) / 7); const py_spark = (50 + (py - 50) / 7);
            const p_opc = Math.min(Math.max(20 + (Math.abs(pa) * 1.5), 20), 90);
            // Rotation removed for cleaner hover
            target.classList.add('holo-active');
            target.style.setProperty('--thumb-gradient-pos-x', `${lp}%`); target.style.setProperty('--thumb-gradient-pos-y', `${tp}%`);
            target.style.setProperty('--thumb-sparkle-pos-x', `${px_spark}%`); target.style.setProperty('--thumb-sparkle-pos-y', `${py_spark}%`);
            target.style.setProperty('--thumb-sparkle-opacity', p_opc / 100);
            clearTimeout(activeHoloTimeout);
         }
        function handleHoloEnd(e) {
              const target = e.target.closest('.thumbnail');
             if (target && target.classList.contains('holo-active') && !target.classList.contains('holo-click-active')) {
                  resetHoloEffect(target);
             } else {
                  const currentlyActive = itemGallery.querySelector('.thumbnail.holo-active');
                  if (currentlyActive && !currentlyActive.classList.contains('holo-click-active')) {
                       resetHoloEffect(currentlyActive);
                  }
             }
         }
        function resetHoloEffect(element, resetTransform = true) {
              element.classList.remove('holo-active');
             if (resetTransform && !element.classList.contains('holo-click-active')) {
                  element.style.transform = 'scale(1)'; // Reset scale
             }
             element.style.removeProperty('--thumb-gradient-pos-x'); element.style.removeProperty('--thumb-gradient-pos-y');
             element.style.removeProperty('--thumb-sparkle-pos-x'); element.style.removeProperty('--thumb-sparkle-pos-y');
             element.style.removeProperty('--thumb-sparkle-opacity');
         }

        // --- Lightbox Holo Effect Logic ---
        function applyLightboxHoloListeners(containerElement) {
              if (!containerElement) { console.warn("Lightbox container not found for holo listeners."); return; } // Added check
             containerElement.addEventListener('mousemove', handleLightboxHoloMove);
             containerElement.addEventListener('touchmove', handleLightboxHoloMove, { passive: false });
             containerElement.addEventListener('mouseleave', handleLightboxHoloEnd);
             containerElement.addEventListener('touchend', handleLightboxHoloEnd);
             containerElement.addEventListener('touchcancel', handleLightboxHoloEnd);
         }
        function handleLightboxHoloMove(e) {
             const target = lightboxImageContainer;
            if (!target || !lightboxOverlay.classList.contains('visible')) return;
            const relatedTarget = e.relatedTarget || e.target;
            // Check if hovering over controls or the image itself (which is inside the container)
            if (relatedTarget && (relatedTarget.closest('.lightbox-controls') || relatedTarget.closest('.lightbox-close') || relatedTarget === lightboxImage)) {
                 if (target.classList.contains('holo-active')) { resetLightboxHoloEffect(); }
                 return;
            }
            const rect = target.getBoundingClientRect(); let clientX, clientY;
            if (e.type === "touchmove") { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; e.preventDefault(); }
            else { clientX = e.clientX; clientY = e.clientY; }
            const offsetX = clientX - rect.left; const offsetY = clientY - rect.top;
            const w = target.offsetWidth; const h = target.offsetHeight;
            if (w === 0 || h === 0) return;
            const px = Math.abs(Math.floor(100 / w * offsetX) - 100); const py = Math.abs(Math.floor(100 / h * offsetY) - 100);
            const pa = (50 - px) + (50 - py);
            const lp = (50 + (px - 50) / 1.8); const tp = (50 + (py - 50) / 1.8);
            const px_spark = (50 + (px - 50) / 8); const py_spark = (50 + (py - 50) / 8);
            const p_opc = Math.min(Math.max(15 + (Math.abs(pa) * 1.2), 15), 75);
            const ty = ((tp - 50) / 2.5) * -1; const tx = ((lp - 50) / 2.0) * 0.4;
            target.classList.add('holo-active');
            target.style.transform = `rotateX(${ty}deg) rotateY(${tx}deg)`;
            target.style.setProperty('--lb-gradient-pos-x', `${lp}%`); target.style.setProperty('--lb-gradient-pos-y', `${tp}%`);
            target.style.setProperty('--lb-sparkle-pos-x', `${px_spark}%`); target.style.setProperty('--lb-sparkle-pos-y', `${py_spark}%`);
            target.style.setProperty('--lb-sparkle-opacity', p_opc / 100);
            clearTimeout(activeLightboxHoloTimeout);
         }
        function handleLightboxHoloEnd(e) {
              const relatedTarget = e.relatedTarget;
             if (relatedTarget && lightboxImageContainer.contains(relatedTarget) && relatedTarget !== lightboxImageContainer) { return; } // Don't hide if moving to child
            if (lightboxImageContainer.classList.contains('holo-active')) { resetLightboxHoloEffect(); }
         }
        function resetLightboxHoloEffect() {
             const target = lightboxImageContainer;
             if (!target) return; // Add check
            target.classList.remove('holo-active');
            target.style.transform = '';
            target.style.removeProperty('--lb-gradient-pos-x'); target.style.removeProperty('--lb-gradient-pos-y');
            target.style.removeProperty('--lb-sparkle-pos-x'); target.style.removeProperty('--lb-sparkle-pos-y');
            target.style.removeProperty('--lb-sparkle-opacity');
            target.style.removeProperty('box-shadow');
         }

        // --- Helper Functions for Color Manipulation ---
        function hexToRgba(hex, alpha = 1) {
            hex = hex.replace('#', '');
            if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            const bigint = parseInt(hex, 16);
            if (isNaN(bigint)) return `rgba(107, 114, 128, ${alpha})`;
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function lightenHexColor(hex, percent) {
             hex = hex.replace('#', '');
             if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
             const num = parseInt(hex, 16);
             if (isNaN(num)) return '#FFFFFF';
             const amt = Math.max(-255, Math.min(255, Math.round(2.55 * percent * 100)));
             let r = (num >> 16) + amt;
             let g = ((num >> 8) & 0x00FF) + amt;
             let b = (num & 0x0000FF) + amt;
             r = Math.max(0, Math.min(255, r));
             g = Math.max(0, Math.min(255, g));
             b = Math.max(0, Math.min(255, b));
             const originalLuminance = (0.2126 * ((num >> 16)/255) + 0.7152 * (((num >> 8) & 0x00FF)/255) + 0.0722 * ((num & 0x0000FF)/255));
             if (originalLuminance < 0.4 && percent > 0) {
                  const minLightness = 180;
                  r = Math.max(r, minLightness);
                  g = Math.max(g, minLightness);
                  b = Math.max(b, minLightness);
             }
             return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("[Init] DOM Loaded. Checking for imageData...");
             // Corrected check for the loaded data structure
             if (typeof imageData === 'undefined' || typeof imageData.imageStructure !== 'object' || typeof imageData.filterConfig !== 'object') {
                 console.error("[Init] ERROR: 'imageData' object (with .imageStructure and .filterConfig) is missing or invalid in image_data.js.");
                 displayError(`Configuration Error! Please run 'npm run build:images' and ensure 'image_data.js' is generated correctly with both 'imageStructure' and 'filterConfig' keys.`);
                 return;
             }
             console.log("[Init] imageData found:", imageData);
             rootImageStructure = imageData.imageStructure;
             filterConfig = imageData.filterConfig;

             if (!rootImageStructure || !rootImageStructure.path || !filterConfig.rarityOrder) {
                  console.error("[Init] ERROR: Loaded data structure or config is incomplete.");
                  displayError(`Configuration Error! Data loaded from image_data.js is incomplete.`);
                  return;
             }

             populateFilters();
             renderTabs();

             // --- Size Slider Initialization ---
             const savedThumbSize = localStorage.getItem('thumbnailSizeIndex');
             const savedPopupSize = localStorage.getItem('popupSizeIndex');
             currentThumbSizeIndex = savedThumbSize !== null ? parseInt(savedThumbSize, 10) : 1;
             currentPopupSizeIndex = savedPopupSize !== null ? parseInt(savedPopupSize, 10) : 2;

             thumbSizeSlider.value = currentThumbSizeIndex;
             popupSizeSlider.value = currentPopupSizeIndex;
             thumbSizeValue.textContent = SIZE_MAP[currentThumbSizeIndex];
             popupSizeValue.textContent = SIZE_MAP[currentPopupSizeIndex];
             updateGalleryGridClass();
             // Apply initial popup size class
             lightboxContent.classList.remove(...POPUP_SIZE_CLASSES);
             lightboxContent.classList.add(POPUP_SIZE_CLASSES[currentPopupSizeIndex]);


             // --- Size Slider Event Listeners ---
             thumbSizeSlider.addEventListener('input', (e) => {
                  const newIndex = parseInt(e.target.value, 10);
                  currentThumbSizeIndex = newIndex;
                  thumbSizeValue.textContent = SIZE_MAP[newIndex];
                  localStorage.setItem('thumbnailSizeIndex', newIndex);
                  updateGalleryGridClass();
             });
             popupSizeSlider.addEventListener('input', (e) => {
                  const newIndex = parseInt(e.target.value, 10);
                  currentPopupSizeIndex = newIndex;
                  popupSizeValue.textContent = SIZE_MAP[newIndex];
                  localStorage.setItem('popupSizeIndex', newIndex);
                  if (lightboxOverlay.classList.contains('visible')) {
                       lightboxContent.classList.remove(...POPUP_SIZE_CLASSES);
                       lightboxContent.classList.add(POPUP_SIZE_CLASSES[newIndex]);
                  }
             });
             // --- End Size Slider Init ---

             baseImageSet = getAllImageFilesRecursive(rootImageStructure);
             console.log("[Init] Initial base image set size:", baseImageSet.length);
             applyFiltersAndRender(); // Initial render

             // --- Event Listeners ---
             loadMoreButton.addEventListener('click', renderNextBatch);
             lightboxCloseBtn.addEventListener('click', closeLightbox);
             lightboxPrevBtn.addEventListener('click', showPrevImage);
             lightboxNextBtn.addEventListener('click', showNextImage);
             lightboxOverlay.addEventListener('click', (e) => { if (e.target === lightboxOverlay) { closeLightbox(); } });
             typeFilterSelect.addEventListener('change', (e) => { currentTypeFilter = e.target.value; applyFiltersAndRender(); });
             rarityFilterSelect.addEventListener('change', (e) => { currentRarityFilter = e.target.value; applyFiltersAndRender(); });
             document.addEventListener('keydown', (e) => { if (lightboxOverlay.classList.contains('visible')) { handleLightboxKeyDown(e); } else { if (document.activeElement && (itemGallery.contains(document.activeElement) || tabContainer.contains(document.activeElement))) { handleGalleryKeyDown(e); } } });
             applyHoloListeners('#item-gallery');
             // Ensure lightbox container exists before adding listener
             if (lightboxImageContainer) {
                applyLightboxHoloListeners(lightboxImageContainer);
             } else {
                 console.error("Lightbox image container not found for holo listeners.");
             }
        });

        /** Updates the grid classes on the gallery based on currentThumbSizeIndex */
        function updateGalleryGridClass() {
             if (!itemGallery) return;
             const existingGridClasses = Array.from(itemGallery.classList).filter(cls => cls.startsWith('grid-cols') || cls.startsWith('sm:grid-cols') || cls.startsWith('md:grid-cols') || cls.startsWith('lg:grid-cols') || cls.startsWith('xl:grid-cols'));
             itemGallery.classList.remove(...existingGridClasses);
             itemGallery.classList.add(...THUMB_GRID_CLASSES[currentThumbSizeIndex].split(' '));
        }

        // --- (Paste ALL other JS functions here) ---
         // findFolderByPath, getAllImageFilesRecursive, openLightbox, closeLightbox,
         // showNextImage, showPrevImage, updateLightboxControls, highlightThumbnail,
         // unhighlightAllThumbnails, renderGalleryView, applyFiltersAndRender,
         // populateFilters, renderTabs, displayError, handleGalleryKeyDown,
         // handleLightboxKeyDown, applyHoloListeners, handleHoloMove, handleHoloEnd,
         // resetHoloEffect, applyLightboxHoloListeners, handleLightboxHoloMove,
         // handleLightboxHoloEnd, resetLightboxHoloEffect, hexToRgba, lightenHexColor


    </script>

</body>
</html>
