<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forte Card Previewer - v2.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pirata+One&display=swap" rel="stylesheet">
    
    <script src="filter_config.js"></script> 
    <style>
        :root {
            --color-primary: #f87171; --color-secondary: #5a0866; --color-bg-dark: #0f172a;
            --color-bg-panel: rgba(23, 37, 59, 0.97); --color-bg-input: rgba(30, 41, 59, 0.9);
            --color-text-primary: #e5e7eb; --color-text-secondary: #9ca3af;
            --color-text-placeholder: #6b7280; --color-border: rgba(55, 65, 81, 0.7);
            --color-border-light: rgba(71, 85, 105, 0.5); --color-accent: #fbbf24;
            --color-error: #ef4444; --color-success: #22c55e; --color-info: #3b82f6;
            --color-focus-ring: rgba(99, 102, 241, 0.5);
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            background-color: var(--color-bg-dark); color: var(--color-text-primary);
            font-family: 'Inter', sans-serif; display: flex; flex-direction: column;
        }
        .font-pirata { font-family: 'Pirata One', cursive; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(17,24,39,0.3); border-radius:4px; }
        ::-webkit-scrollbar-thumb { background: var(--color-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7e2c92; }

        .app-header { flex-shrink: 0; background-color: var(--color-bg-panel); box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 100;}
        .app-set-navigation { flex-shrink: 0; background-color: rgba(17, 24, 39, 0.85); padding: 0.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 90;}
        .app-main-content { flex-grow: 1; display: flex; overflow: hidden; }
        .app-sidebar { width: 280px; flex-shrink: 0; background-color: var(--color-bg-panel); padding: 1rem; overflow-y: auto; border-right: 1px solid var(--color-border); }
        .app-gallery-area { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        
        @media (max-width: 1023px) { 
            .app-main-content { flex-direction: column; }
            .app-sidebar { width: 100%; max-height: 45vh; border-right: none; border-bottom: 1px solid var(--color-border); }
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1.5rem; max-width: 1400px; margin: 0 auto; }
        .brand-area { display: flex; align-items: center; gap: 0.75rem; }
        .logo { max-height: 40px; width: auto; filter: drop-shadow(0 0 5px rgba(248,113,113,0.5)); }
        .title-glow { font-family: 'Pirata One', cursive; font-size: 1.75rem; color: var(--color-primary); text-shadow: 0 0 4px #f87171, 0 0 8px #f87171; }
        
        .filter-group { margin-bottom: 1.25rem; }
        .filter-label { display: block; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .filter-select {
            width: 100%; background-color: var(--color-bg-input); color: var(--color-text-primary);
            border: 1px solid var(--color-border); border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }
        .filter-select:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px var(--color-focus-ring); }

        #tab-container { 
            display: flex; flex-direction: row; flex-wrap: wrap; 
            justify-content: center; gap: 0.5rem; 
        }
        .tab {
            background-color: transparent; color: var(--color-text-secondary);
            border: 1px solid transparent; border-bottom: 3px solid transparent; 
            border-radius: 0.375rem 0.375rem 0 0; padding: 0.6rem 1rem; 
            font-size: 0.875rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease; white-space: nowrap;
        }
        .tab:hover { 
            background-color: rgba(255,255,255,0.03); /* Lighter hover */
            color: var(--color-text-primary);
            border-bottom-color: rgba(255,255,255,0.1);
        }
        .tab.active {
            background-color: var(--tab-active-bg-color, var(--color-bg-panel)); 
            color: var(--tab-active-text-color, var(--color-primary));
            border-color: var(--color-border-light); /* Lighter border for active tab */
            border-bottom-color: var(--tab-active-border-color, var(--color-primary)); 
            font-weight: 600;
        }

        #item-gallery { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } 
        .thumbnail {
            position: relative; background-color: rgba(42,48,71,0.7); 
            border-radius: 0.375rem; overflow: hidden;
            cursor: pointer; aspect-ratio: 2.5 / 3.5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .thumbnail:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .forte-indicator {
             position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(220, 38, 38, 0.85); color: white;
             border-radius: 50%; width: 1.25rem; height: 1.25rem; display: flex; align-items: center;
             justify-content: center; font-size: 0.65rem; box-shadow: 0 0 4px black;
        }
        #empty-folder-message { text-align: center; padding: 2rem; color: var(--color-text-secondary); }
        .loader { 
             border: 4px solid rgba(229,231,235,0.2); border-top: 4px solid var(--color-primary);
             border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        #page-loading-overlay { position: fixed; inset:0; background:var(--color-bg-dark); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: opacity 0.5s ease; }
        #page-loading-overlay.loaded { opacity: 0; pointer-events: none; }
        #loading-text { margin-top: 1rem; color: var(--color-primary); font-weight: 500; }

        #fancy-lightbox {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.92); 
            z-index: 10000; display: none; /* Initially hidden */
            align-items: center; justify-content: center; padding: 1rem;
            opacity: 0; transition: opacity 0.25s ease-in-out;
        }
        #fancy-lightbox.visible { display: flex; opacity: 1; }
        .fancy-lightbox-content {
            background-color: var(--color-bg-dark); 
            color: var(--color-text-primary);
            border: 1px solid var(--color-border); 
            border-radius: 0.5rem; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.7); 
            width: 90vw; max-width: 1000px; height: 90vh; max-height: 750px;
            display: flex; flex-direction: column; position: relative;
            overflow: hidden; 
        }
        .fancy-lightbox-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 1rem; border-bottom: 1px solid var(--color-border);
            flex-shrink: 0; background-color: var(--color-bg-panel); 
        }
        .fancy-lightbox-title { font-size: 1.1rem; font-weight: 600; color: var(--color-primary); }
        .fancy-lightbox-close {
            background: none; border: none; color: var(--color-text-secondary); font-size: 1.4rem; 
            cursor: pointer; padding: 0.4rem; line-height: 1;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .fancy-lightbox-close:hover { color: var(--color-primary); transform: rotate(90deg) scale(1.1); }

        .fancy-lightbox-body { flex-grow: 1; display: flex; overflow: hidden; }
        .fancy-card-image-container { 
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 0.5rem; overflow: hidden; position: relative; 
            background-color: rgba(0,0,0,0.2); 
        }
        #fancy-card-image {
            display: block; max-width: 100%; max-height: 100%; 
            object-fit: contain; border-radius: 0.375rem; 
            opacity: 0; transition: opacity 0.3s ease; 
        }
        #fancy-card-image.loaded { opacity: 1; }
        #fancy-spinner { 
            border-width: 3px; width: 30px; height: 30px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        .fancy-card-info {
            width: 300px; 
            flex-shrink: 0; padding: 1rem; overflow-y: auto;
            border-left: 1px solid var(--color-border);
            background-color: var(--color-bg-panel); 
        }
        .card-detail-section { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border-light); }
        .card-detail-section:last-child { border-bottom: none; margin-bottom: 0;}
        .info-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-secondary); margin-bottom: 0.4rem; display:flex; align-items:center; }
        .info-section-title i { margin-right: 0.4rem; color: var(--color-accent); font-size: 0.8rem; }
        .info-item { margin-bottom: 0.4rem; }
        .info-label { font-size: 0.7rem; color: var(--color-text-secondary); }
        .info-value { font-size: 0.8rem; color: var(--color-text-primary); word-break: break-word; }
        .card-types { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top:0.1rem;}
        .card-type-badge { padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; }
        
        .attack-cost, #retreat-cost { display: flex; flex-wrap: wrap; gap: 0.2rem; }
        .energy-symbol {
            width: 16px; height: 16px; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; font-size: 0.65rem;
            font-weight: bold; color: white; border: 1px solid rgba(0,0,0,0.1);
        }
        .energy-grass { background-color: #78C850; } .energy-fire { background-color: #F08030; }
        .energy-water { background-color: #6890F0; } .energy-lightning { background-color: #F8D030; color: #333; }
        .energy-fighting { background-color: #C03028; } .energy-psychic { background-color: #F85888; }
        .energy-colorless { background-color: #A8A878; } .energy-darkness { background-color: #705848; }
        .energy-metal { background-color: #B8B8D0; color: #333;} .energy-dragon { background-color: #7038F8; }
        .energy-fairy { background-color: #EE99AC; color: #333;}
        .ability-container, .attack-container { background: rgba(0,0,0,0.1); padding: 0.4rem; border-radius: 0.25rem; margin-bottom: 0.4rem; }
        .ability-name, .attack-name { font-weight: 600; color: var(--color-accent); font-size:0.85rem; }
        .ability-text, .attack-text { font-size: 0.75rem; margin-top: 0.2rem; line-height: 1.3; }

        .fancy-nav-controls { position: absolute; top: 50%; left: 0.25rem; right: 0.25rem; transform: translateY(-50%); display: flex; justify-content: space-between; pointer-events: none; z-index:10; }
        .fancy-nav-button { background: rgba(0,0,0,0.3); color: white; border:none; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; pointer-events:auto; transition: background-color 0.2s; }
        .fancy-nav-button:hover:not(:disabled) { background: rgba(0,0,0,0.6); }
        .fancy-nav-button:disabled { opacity:0.3; cursor:not-allowed; }
        #fancy-normal-view { display: none; } 

        @media (max-width: 768px) {
            .app-sidebar { max-height: 50vh; } 
            .fancy-lightbox-content { flex-direction: column; width: 95vw; height: 95vh; max-height: 95vh; }
            .fancy-card-info { width: 100%; max-height: 45%; border-left: none; border-bottom: 1px solid var(--color-border); order: 2; }
            .fancy-card-image-container { order: 1; padding: 0.5rem; }
            .fancy-nav-controls { left:0.1rem; right:0.1rem; }
            .fancy-nav-button { width:30px; height:30px; font-size:0.8rem; }
        }
   </style>
</head>
<body>
    <div id="page-loading-overlay">
        <div class="loader"></div>
        <div id="loading-text">Loading Card Data...</div>
    </div>

    <header class="app-header">
        <div class="header-content">
            <div class="brand-area">
                <img src="https://raw.githubusercontent.com/Envoyofhell/Pocket-Image-Previewer/Forte/resources/forte-arrivals.png?raw=true" alt="Forte Logo" class="logo">
                <h1 class="title-glow">Forte Card Viewer</h1>
            </div>
            <div id="access-controls" class="flex items-center gap-x-3">
                 <button id="submission-button" title="Submit a Card" style="background: var(--color-secondary); color:white; border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.8rem; display:flex; align-items:center; gap: 0.5rem;">
                    <i class="fas fa-upload"></i>Submit Card
                </button>
            </div>
        </div>
    </header>

    <nav id="set-tab-navigation" class="app-set-navigation w-full">
        <div id="tab-container" class="max-w-7xl mx-auto">
            </div>
    </nav>

    <div class="app-main-content">
        <aside class="app-sidebar">
            <h2 class="text-lg font-semibold mt-1 mb-3 text-white">Filters</h2>
            <div class="filter-group">
                <label for="supertype-filter" class="filter-label">Card Category</label>
                <select id="supertype-filter" class="filter-select">
                    <option value="all">All Categories</option>
                    <option value="Pokémon">Pokémon</option>
                    <option value="Trainer">Trainer</option>
                    <option value="Energy">Energy</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="type-filter" class="filter-label">Pokémon Type / Trainer Subtype</label>
                <select id="type-filter" class="filter-select">
                    <option value="all">All Types/Subtypes</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="rarity-filter" class="filter-label">Rarity</label>
                <select id="rarity-filter" class="filter-select">
                    <option value="all">All Rarities</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="creator-filter" class="filter-label">Creator/Artist</label>
                <select id="creator-filter" class="filter-select">
                    <option value="all">All Creators</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="forte-filter" class="filter-label">Forte Status</label>
                <select id="forte-filter" class="filter-select">
                </select>
            </div>
             <div class="filter-group">
                <label for="sort-filter" class="filter-label">Sort By</label>
                <select id="sort-filter" class="filter-select">
                    <option value="setThenNumber">Set, then Number</option>
                    <option value="name">Name (A-Z)</option>
                    <option value="hp">HP (High to Low)</option>
                    <option value="artist">Artist (A-Z)</option>
                    <option value="rarity">Rarity</option>
                    <option value="recent">Recently Added</option>
                </select>
            </div>
        </aside>

        <main class="app-gallery-area">
            <div id="item-gallery" role="grid"></div>
            <p id="empty-folder-message" class="text-center mt-8 text-lg text-gray-500 hidden">
                No cards match your current filters. Try adjusting them!
            </p>
        </main>
    </div>

    <div id="fancy-lightbox" class="fancy-lightbox-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="fancy-lightbox-content">
            <div class="fancy-lightbox-header">
                <h2 class="fancy-lightbox-title"><i class="fas fa-clone mr-2 text-[var(--color-accent)]"></i><span id="card-title-lightbox">Card Details</span></h2>
                <button id="fancy-lightbox-close" class="fancy-lightbox-close" aria-label="Close card viewer"><i class="fas fa-times"></i></button>
            </div>
            <div class="fancy-lightbox-body">
                <div class="fancy-card-image-container">
                    <div id="fancy-spinner" class="loader"></div>
                    <img id="fancy-card-image" src="#" alt="Card preview" class="hidden">
                </div>
                <aside class="fancy-card-info">
                    <div class="card-detail-section">
                        <div class="info-section-title"><i class="fas fa-id-card"></i><span>Identity</span></div>
                        <div class="info-item"><span class="info-label">Name:</span> <span id="lb-card-name" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Set:</span> <span id="lb-set-name" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Number:</span> <span id="lb-card-number" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Rarity:</span> <span id="lb-rarity" class="info-value">-</span></div>
                    </div>

                    <div id="lb-pokemon-details" class="card-detail-section" style="display:none;">
                        <div class="info-section-title"><i class="fas fa-dna"></i><span>Pokémon Info</span></div>
                        <div class="info-item"><span class="info-label">HP:</span> <span id="lb-hp" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Type(s):</span> <div id="lb-types" class="card-types info-value"></div></div>
                        <div class="info-item" id="lb-stage-item" style="display:none;"><span class="info-label">Stage:</span> <span id="lb-stage" class="info-value">-</span></div>
                        <div class="info-item" id="lb-evolves-from-item" style="display:none;"><span class="info-label">Evolves From:</span> <span id="lb-evolves-from" class="info-value">-</span></div>
                         <div class="info-item" id="lb-pokedex-item" style="display:none;"><span class="info-label">Pokédex Data:</span> <span id="lb-pokedex-data" class="info-value">-</span></div>
                    </div>
                    
                    <div id="lb-trainer-details" class="card-detail-section" style="display:none;">
                         <div class="info-section-title"><i class="fas fa-briefcase"></i><span>Trainer Info</span></div>
                         <div class="info-item"><span class="info-label">Subtype(s):</span> <div id="lb-trainer-subtypes" class="card-types info-value"></div></div>
                    </div>
                     <div id="lb-energy-details" class="card-detail-section" style="display:none;">
                         <div class="info-section-title"><i class="fas fa-bolt"></i><span>Energy Info</span></div>
                         <div class="info-item"><span class="info-label">Type:</span> <div id="lb-energy-types" class="card-types info-value"></div></div>
                    </div>

                    <div id="lb-abilities-section" class="card-detail-section" style="display:none;">
                        <div class="info-section-title"><i class="fas fa-star"></i><span>Abilities</span></div>
                        <div id="lb-abilities-container"></div>
                    </div>
                    <div id="lb-attacks-section" class="card-detail-section" style="display:none;">
                        <div class="info-section-title"><i class="fas fa-fist-raised"></i><span>Attacks</span></div>
                        <div id="lb-attacks-container"></div>
                    </div>
                     <div id="lb-rules-section" class="card-detail-section" style="display:none;">
                        <div class="info-section-title"><i class="fas fa-scroll"></i><span>Rules/Effect</span></div>
                        <div id="lb-rules-text" class="info-value" style="white-space: pre-wrap;"></div>
                    </div>

                    <div id="lb-battle-stats-section" class="card-detail-section" style="display:none;">
                         <div class="info-section-title"><i class="fas fa-shield-alt"></i><span>Battle Stats</span></div>
                         <div id="lb-weakness-container" class="info-item" style="display:none;"><span class="info-label">Weakness:</span> <span id="lb-weakness" class="info-value"></span></div>
                         <div id="lb-resistance-container" class="info-item" style="display:none;"><span class="info-label">Resistance:</span> <span id="lb-resistance" class="info-value"></span></div>
                         <div id="lb-retreat-cost-item" class="info-item" style="display:none;"><span class="info-label">Retreat Cost:</span> <div id="lb-retreat-cost" class="attack-cost"></div></div>
                    </div>

                    <div id="lb-flavor-text-section" class="card-detail-section" style="display:none;">
                        <div class="info-section-title"><i class="fas fa-quote-left"></i><span>Flavor Text</span></div>
                        <div id="lb-flavor-text" class="info-value" style="font-style: italic; opacity: 0.9;">-</div>
                    </div>

                    <div class="card-detail-section">
                        <div class="info-section-title"><i class="fas fa-pencil-alt"></i><span>Credits & Meta</span></div>
                        <div class="info-item"><span class="info-label">Artist:</span> <span id="lb-artist" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Creator (Discord):</span> <span id="lb-creator" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Forte Card:</span> <span id="lb-is-forte" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Regulation:</span> <span id="lb-regulation" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">Approved:</span> <span id="lb-approved-date" class="info-value">-</span></div>
                    </div>
                </aside>
            </div>
             <div class="fancy-nav-controls">
                <button id="fancy-prev-button" class="fancy-nav-button" aria-label="Previous card"><i class="fas fa-chevron-left"></i></button>
                <button id="fancy-next-button" class="fancy-nav-button" aria-label="Next card"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Ensure SITE_CONFIG is loaded from filter-config.js
        if (typeof SITE_CONFIG === 'undefined') {
            console.error("CRITICAL: SITE_CONFIG not loaded. Make sure filter-config.js is included and loaded correctly before this script.");
            document.body.innerHTML = '<div style="color:red; padding:20px; font-size:1.2em;">Error: Site configuration (filter-config.js) is missing or failed to load. Application cannot start.</div>';
        }

        let allCardsData = [];
        let currentFilteredCardsForLightbox = [];
        let currentLightboxIndex = -1;

        // DOM Elements (ensure all are correctly identified)
        const itemGalleryEl = document.getElementById('item-gallery');
        const tabContainerEl = document.getElementById('tab-container'); 
        const typeFilterEl = document.getElementById('type-filter');
        const supertypeFilterEl = document.getElementById('supertype-filter');
        const rarityFilterEl = document.getElementById('rarity-filter');
        const creatorFilterEl = document.getElementById('creator-filter');
        const forteFilterEl = document.getElementById('forte-filter');
        const sortFilterEl = document.getElementById('sort-filter');
        const emptyMessageEl = document.getElementById('empty-folder-message');
        const loadingOverlayEl = document.getElementById('page-loading-overlay');
        const lightboxEl = document.getElementById('fancy-lightbox');
        const lightboxCloseBtn = document.getElementById('fancy-lightbox-close');
        const lightboxCardTitleEl = document.getElementById('card-title-lightbox');
        const lightboxCardImageEl = document.getElementById('fancy-card-image');
        const lightboxSpinnerEl = document.getElementById('fancy-spinner');
        const lightboxPrevBtn = document.getElementById('fancy-prev-button');
        const lightboxNextBtn = document.getElementById('fancy-next-button');
        
        const lbElements = { 
            cardName: document.getElementById('lb-card-name'), setName: document.getElementById('lb-set-name'),
            cardNumber: document.getElementById('lb-card-number'), rarity: document.getElementById('lb-rarity'),
            artist: document.getElementById('lb-artist'), pokemonDetails: document.getElementById('lb-pokemon-details'),
            hp: document.getElementById('lb-hp'), types: document.getElementById('lb-types'),
            stageItem: document.getElementById('lb-stage-item'), stage: document.getElementById('lb-stage'),
            evolvesFromItem: document.getElementById('lb-evolves-from-item'), evolvesFrom: document.getElementById('lb-evolves-from'),
            pokedexItem: document.getElementById('lb-pokedex-item'), pokedexData: document.getElementById('lb-pokedex-data'),
            trainerDetails: document.getElementById('lb-trainer-details'), trainerSubtypes: document.getElementById('lb-trainer-subtypes'),
            energyDetails: document.getElementById('lb-energy-details'), energyTypes: document.getElementById('lb-energy-types'),
            abilitiesSection: document.getElementById('lb-abilities-section'), abilitiesContainer: document.getElementById('lb-abilities-container'),
            attacksSection: document.getElementById('lb-attacks-section'), attacksContainer: document.getElementById('lb-attacks-container'),
            rulesSection: document.getElementById('lb-rules-section'), rulesText: document.getElementById('lb-rules-text'),
            battleStatsSection: document.getElementById('lb-battle-stats-section'),
            weaknessContainer: document.getElementById('lb-weakness-container'), weakness: document.getElementById('lb-weakness'),
            resistanceContainer: document.getElementById('lb-resistance-container'), resistance: document.getElementById('lb-resistance'),
            retreatCostItem: document.getElementById('lb-retreat-cost-item'), retreatCost: document.getElementById('lb-retreat-cost'),
            flavorTextSection: document.getElementById('lb-flavor-text-section'), flavorText: document.getElementById('lb-flavor-text'),
            creator: document.getElementById('lb-creator'), isForte: document.getElementById('lb-is-forte'),
            regulation: document.getElementById('lb-regulation'), approvedDate: document.getElementById('lb-approved-date')
        };

        let currentFilters = { type: 'all', supertype: 'all', rarity: 'all', creator: 'all', forte: 'all' };
        let currentSort = 'setThenNumber';
        let currentSetTab = SITE_CONFIG.defaultActiveSetTab === 'all' ? 'all' : (SITE_CONFIG.setDisplayNameToCodeMap[SITE_CONFIG.defaultActiveSetTab] || 'all');

        async function initializeApp() {
            try {
                const response = await fetch('data/cards.json?timestamp=' + new Date().getTime()); 
                if (!response.ok) throw new Error(`HTTP error ${response.status} fetching cards.json. Make sure 'data/cards.json' exists and is accessible.`);
                allCardsData = await response.json();
                if (!Array.isArray(allCardsData)) throw new Error("Fetched card data is not an array.");

                console.log(`Loaded ${allCardsData.length} cards.`);
                populateFilterDropdowns();
                renderSetTabs();
                setupEventListeners();
                
                const defaultTabEl = document.querySelector(`.tab[data-set-id="${currentSetTab}"]`);
                if(defaultTabEl) defaultTabEl.click(); else applyFiltersAndRender();

            } catch (error) {
                console.error("Initialization failed:", error);
                itemGalleryEl.innerHTML = `<p class="text-red-500 text-center col-span-full">Error loading card data: ${error.message}.</p>`;
            } finally {
                if (loadingOverlayEl) loadingOverlayEl.classList.add('loaded');
            }
        }

        function populateFilterDropdowns() { 
            const types = new Set(); const trainerSubtypes = new Set();
            const rarities = new Set(); const creators = new Set();
            allCardsData.forEach(card => {
                if (card.supertype === "Pokémon" && card.types) card.types.forEach(t => types.add(t));
                if (card.supertype === "Trainer" && card.subtypes) card.subtypes.forEach(st => trainerSubtypes.add(st));
                if (card.rarity) rarities.add(card.rarity);
                if (card.artist) creators.add(card.artist);
                if (card.forteData?.discordUsername) creators.add(card.forteData.discordUsername);
            });
            const sortAndPopulate = (el, itemsSet, orderConfig, allText) => {
                const ordered = orderConfig.filter(item => itemsSet.has(item));
                const unordered = Array.from(itemsSet).filter(item => !orderConfig.includes(item)).sort();
                populateSelectWithOptions(el, [...ordered, ...unordered], allText);
            };
            const combinedTypesAndSubtypes = new Set([...types, ...trainerSubtypes]);
            const combinedOrder = [...SITE_CONFIG.pokemonTypeOrder, ...SITE_CONFIG.trainerSubtypeOrder];
            sortAndPopulate(typeFilterEl, combinedTypesAndSubtypes, combinedOrder, "All Types/Subtypes");
            sortAndPopulate(rarityFilterEl, rarities, SITE_CONFIG.rarityOrder, "All Rarities");
            populateSelectWithOptions(creatorFilterEl, Array.from(creators).sort(), "All Creators");
            forteFilterEl.innerHTML = '';
            for (const [value, text] of Object.entries(SITE_CONFIG.forteStatusOptions)) {
                const option = document.createElement('option'); option.value = value; option.textContent = text;
                forteFilterEl.appendChild(option);
            }
        }
        function populateSelectWithOptions(selectElement, optionsArray, allText) { 
            selectElement.innerHTML = `<option value="all">${allText}</option>`;
            optionsArray.forEach(opt => {
                const option = document.createElement('option'); option.value = opt; option.textContent = opt;
                selectElement.appendChild(option);
            });
        }

        function renderSetTabs() { 
            const setCounts = {};
            allCardsData.forEach(card => {
                if (card.set?.id && card.set?.name) { 
                    if (!setCounts[card.set.id]) {
                        setCounts[card.set.id] = { name: card.set.name, count: 0, id: card.set.id };
                    }
                    setCounts[card.set.id].count++;
                } else {
                    const defaultMiscId = "misc_unknown"; 
                     if (!setCounts[defaultMiscId]) {
                        setCounts[defaultMiscId] = { name: "Unknown Set", count: 0, id: defaultMiscId };
                    }
                    setCounts[defaultMiscId].count++;
                }
            });
            const orderedSetsForTabs = SITE_CONFIG.setOrder
                .map(setName => {
                    const setCode = SITE_CONFIG.setDisplayNameToCodeMap[setName];
                    return setCode && setCounts[setCode] ? setCounts[setCode] : null;
                })
                .filter(Boolean);
            Object.values(setCounts).forEach(setInfo => {
                if (!orderedSetsForTabs.find(s => s.id === setInfo.id)) {
                    orderedSetsForTabs.push(setInfo); 
                }
            });
            tabContainerEl.innerHTML = ''; 
            const allTab = createTabElement('all', `All Sets (${allCardsData.length})`, SITE_CONFIG.setColors['All'] || SITE_CONFIG.setColors['default']);
            tabContainerEl.appendChild(allTab);
            orderedSetsForTabs.forEach(setInfo => {
                const tab = createTabElement(setInfo.id, `${setInfo.name} (${setInfo.count})`, SITE_CONFIG.setColors[setInfo.name] || SITE_CONFIG.setColors['default']);
                tabContainerEl.appendChild(tab);
            });
        }
        function createTabElement(setId, text, color) { 
            const button = document.createElement('button');
            button.className = 'tab'; button.dataset.setId = setId; button.textContent = text;
            if (color) {
                button.style.setProperty('--tab-active-border-color', color);
                button.style.setProperty('--tab-active-bg-color', hexToRgba(color, 0.1)); 
                button.style.setProperty('--tab-active-text-color', color);
            }
            return button;
        }
        function hexToRgba(hex, alpha = 1) { 
            if (!hex || typeof hex !== 'string') return `rgba(107, 114, 128, ${alpha})`;
            hex = hex.replace('#', '');
            if (hex.length === 3) hex = hex[0]+hex[0] + hex[1]+hex[1] + hex[2]+hex[2];
            const bigint = parseInt(hex, 16);
            if (isNaN(bigint)) return `rgba(107, 114, 128, ${alpha})`;
            const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function lightenHexColor(hex, percent) { 
            if (!hex || typeof hex !== 'string') return '#FFFFFF'; hex = hex.replace('#', '');
            if (hex.length === 3) hex = hex[0]+hex[0] + hex[1]+hex[1] + hex[2]+hex[2];
            const num = parseInt(hex, 16); if (isNaN(num)) return '#FFFFFF';
            const amt = Math.round(2.55 * percent * 100);
            let r = (num >> 16) + amt; let g = ((num >> 8) & 0x00FF) + amt; let b = (num & 0x0000FF) + amt;
            r = Math.max(0, Math.min(255, r)); g = Math.max(0, Math.min(255, g)); b = Math.max(0, Math.min(255, b));
            return "#" + (0x1000000 + (r << 16) | (g << 8) | b).toString(16).slice(1).padStart(6, '0');
        }

        function setupEventListeners() { 
            [typeFilterEl, supertypeFilterEl, rarityFilterEl, creatorFilterEl, forteFilterEl, sortFilterEl].forEach(filter => {
                if(filter) filter.addEventListener('change', () => {
                    currentFilters.type = typeFilterEl.value;
                    currentFilters.supertype = supertypeFilterEl.value;
                    currentFilters.rarity = rarityFilterEl.value;
                    currentFilters.creator = creatorFilterEl.value;
                    currentFilters.forte = forteFilterEl.value;
                    currentSort = sortFilterEl.value;
                    applyFiltersAndRender();
                });
            });
            tabContainerEl.addEventListener('click', (e) => {
                const tab = e.target.closest('.tab');
                if (tab && !tab.classList.contains('active')) {
                    tabContainerEl.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active'); currentSetTab = tab.dataset.setId;
                    applyFiltersAndRender();
                }
            });
            lightboxCloseBtn.addEventListener('click', closeLightbox);
            lightboxPrevBtn.addEventListener('click', showPreviousCardInLightbox);
            lightboxNextBtn.addEventListener('click', showNextCardInLightbox);
            document.addEventListener('keydown', (e) => {
                if (lightboxEl.classList.contains('visible')) {
                    if (e.key === 'Escape') closeLightbox();
                    if (e.key === 'ArrowLeft') showPreviousCardInLightbox();
                    if (e.key === 'ArrowRight') showNextCardInLightbox();
                }
            });
            const submissionBtnEl = document.getElementById('submission-button');
            if (submissionBtnEl) {
                submissionBtnEl.addEventListener('click', () => {
                    window.open('YOUR_APPS_SCRIPT_SUBMISSION_WEB_APP_URL_HERE', '_blank');
                });
            }
        }

        function applyFiltersAndRender() { 
            let tempFilteredCards = allCardsData;
            if (currentSetTab !== 'all') {
                tempFilteredCards = tempFilteredCards.filter(card => card.set && card.set.id === currentSetTab);
            }
            if (currentFilters.supertype !== 'all') {
                tempFilteredCards = tempFilteredCards.filter(card => card.supertype === currentFilters.supertype);
            }
            if (currentFilters.type !== 'all') {
                const selectedType = currentFilters.type;
                if (currentFilters.supertype === 'Trainer') {
                    tempFilteredCards = tempFilteredCards.filter(card => card.subtypes && card.subtypes.includes(selectedType));
                } else if (currentFilters.supertype === 'Pokémon' || currentFilters.supertype === 'Energy') {
                    tempFilteredCards = tempFilteredCards.filter(card => card.types && card.types.includes(selectedType));
                } else { 
                     tempFilteredCards = tempFilteredCards.filter(card => 
                        (card.supertype === 'Pokémon' && card.types && card.types.includes(selectedType)) ||
                        (card.supertype === 'Trainer' && card.subtypes && card.subtypes.includes(selectedType)) ||
                        (card.supertype === 'Energy' && card.types && card.types.includes(selectedType))
                     );
                }
            }
            if (currentFilters.rarity !== 'all') {
                tempFilteredCards = tempFilteredCards.filter(card => card.rarity === currentFilters.rarity);
            }
            if (currentFilters.creator !== 'all') {
                tempFilteredCards = tempFilteredCards.filter(card => card.artist === currentFilters.creator || (card.forteData && card.forteData.discordUsername === currentFilters.creator));
            }
            if (currentFilters.forte !== 'all') {
                const isForteTarget = currentFilters.forte === 'isForte';
                tempFilteredCards = tempFilteredCards.filter(card => card.forteData && card.forteData.isForte === isForteTarget);
            }
            tempFilteredCards.sort((a,b) => { 
                switch(currentSort) {
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    case 'hp': return (parseInt(b.hp) || 0) - (parseInt(a.hp) || 0);
                    case 'artist': return (a.artist || a.forteData?.discordUsername || '').localeCompare(b.artist || b.forteData?.discordUsername || '');
                    case 'rarity': 
                        const rarityA = SITE_CONFIG.rarityOrder.indexOf(a.rarity); const rarityB = SITE_CONFIG.rarityOrder.indexOf(b.rarity);
                        return (rarityA === -1 ? 999 : rarityA) - (rarityB === -1 ? 999 : rarityB);
                    case 'recent':
                        const dateA = new Date(a.forteData?.approvedDate || a.set?.releaseDate || '1900-01-01');
                        const dateB = new Date(b.forteData?.approvedDate || b.set?.releaseDate || '1900-01-01');
                        return dateB - dateA;
                    case 'setThenNumber': default:
                        const setIdA = a.set?.id || 'zzz'; const setIdB = b.set?.id || 'zzz';
                        if (setIdA < setIdB) return -1; if (setIdA > setIdB) return 1;
                        return (parseInt(a.number) || 99999) - (parseInt(b.number) || 99999);
                }
            });
            currentFilteredCardsForLightbox = tempFilteredCards;
            renderGalleryThumbs();
        }

        function renderGalleryThumbs() { 
            itemGalleryEl.innerHTML = '';
            if (currentFilteredCardsForLightbox.length === 0) { emptyMessageEl.classList.remove('hidden'); return; }
            emptyMessageEl.classList.add('hidden');
            currentFilteredCardsForLightbox.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'thumbnail'; div.tabIndex = 0;
                div.setAttribute('aria-label', card.name); div.dataset.cardIndex = index;
                const img = document.createElement('img');
                img.src = card.images?.small || card.images?.large || placeholderUrl;
                img.alt = card.name; img.className = 'gallery-image'; img.loading = 'lazy';
                img.onerror = () => img.src = placeholderUrl;
                img.onload = () => img.classList.add('loaded');
                div.appendChild(img);
                if (card.forteData?.isForte) {
                    const forteIndicator = document.createElement('div');
                    forteIndicator.className = 'forte-indicator';
                    forteIndicator.innerHTML = '<i class="fas fa-crown"></i>';
                    div.appendChild(forteIndicator);
                }
                div.addEventListener('click', () => openLightboxWithCard(card));
                div.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') openLightboxWithCard(card); });
                itemGalleryEl.appendChild(div);
            });
        }

        function openLightboxWithCard(cardObject) { 
            currentLightboxIndex = currentFilteredCardsForLightbox.findIndex(c => c.id === cardObject.id);
            updateLightboxDetails(cardObject);
            updateLightboxNav();
            lightboxEl.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }
        function closeLightbox() { 
            lightboxEl.classList.remove('visible'); document.body.style.overflow = ''; 
        }
        
        function updateLightboxDetails(card) { 
            if (!card) { closeLightbox(); return; }
            lightboxCardTitleEl.textContent = card.name || 'Card Details';
            lightboxSpinnerEl.classList.remove('hidden'); lightboxCardImageEl.classList.add('hidden');
            lightboxCardImageEl.onload = () => { lightboxSpinnerEl.classList.add('hidden'); lightboxCardImageEl.classList.remove('hidden'); lightboxCardImageEl.classList.add('loaded'); };
            lightboxCardImageEl.onerror = () => { lightboxCardImageEl.src = placeholderUrl; lightboxSpinnerEl.classList.add('hidden'); lightboxCardImageEl.classList.remove('hidden');};
            const imageUrl = card.images?.large || card.images?.small || placeholderUrl;
            console.log("Setting lightbox image to:", imageUrl); 
            lightboxCardImageEl.src = imageUrl; 
            lightboxCardImageEl.alt = card.name;

            lbElements.cardName.textContent = card.name || '-';
            lbElements.setName.textContent = card.set?.name || '-';
            lbElements.cardNumber.textContent = `${card.number || '-'}${card.set?.printedTotal ? ` / ${card.set.printedTotal}` : ''}`;
            lbElements.rarity.textContent = card.rarity || '-';
            lbElements.artist.textContent = card.artist || '-';
            
            const isPoke = card.supertype === 'Pokémon'; const isTrainer = card.supertype === 'Trainer'; const isEnergy = card.supertype === 'Energy';
            lbElements.pokemonDetails.style.display = isPoke ? 'block' : 'none';
            lbElements.trainerDetails.style.display = isTrainer ? 'block' : 'none';
            lbElements.energyDetails.style.display = isEnergy ? 'block' : 'none';
            lbElements.abilitiesSection.style.display = isPoke && card.abilities?.length ? 'block' : 'none';
            lbElements.attacksSection.style.display = isPoke && card.attacks?.length ? 'block' : 'none';
            lbElements.rulesSection.style.display = (isTrainer || isEnergy) && card.rules?.length ? 'block' : 'none';
            lbElements.battleStatsSection.style.display = isPoke && (card.weaknesses?.length || card.resistances?.length || card.retreatCost?.length) ? 'block' : 'none';
            lbElements.flavorTextSection.style.display = card.flavorText ? 'block' : 'none';

            if (isPoke) {
                lbElements.hp.textContent = card.hp || '-';
                lbElements.types.innerHTML = card.types?.map(t => `<span class="card-type-badge type-${t.toLowerCase()}">${t}</span>`).join(' ') || '-';
                lbElements.stage.textContent = card.subtypes?.join(', ') || '-';
                lbElements.stageItem.style.display = card.subtypes?.length ? 'block' : 'none';
                if (card.evolvesFrom) { lbElements.evolvesFromItem.style.display = 'block'; lbElements.evolvesFrom.textContent = card.evolvesFrom; } 
                else { lbElements.evolvesFromItem.style.display = 'none'; }
                if(card.nationalPokedexNumbers?.length) { lbElements.pokedexItem.style.display = 'block'; lbElements.pokedexData.textContent = card.nationalPokedexNumbers.join(', ');}
                else { lbElements.pokedexItem.style.display = 'none'; }
                lbElements.abilitiesContainer.innerHTML = card.abilities?.map(a => `<div class="ability-container"><div class="ability-name">${a.name} (${a.type})</div><div class="ability-text">${a.text}</div></div>`).join('') || '';
                lbElements.attacksContainer.innerHTML = card.attacks?.map(atk => `
                    <div class="attack-container">
                        <div class="attack-cost">${atk.cost?.map(c => `<span class="energy-symbol energy-${c.toLowerCase()}">${c.charAt(0)}</span>`).join('') || ''}</div>
                        <div class="attack-name">${atk.name} ${atk.damage ? `- ${atk.damage}` : ''}</div>
                        ${atk.text ? `<div class="attack-text">${atk.text}</div>` : ''}
                    </div>`).join('') || '';
                lbElements.weaknessContainer.style.display = card.weaknesses?.length ? 'flex' : 'none';
                lbElements.weakness.innerHTML = card.weaknesses?.map(w => `<span class="card-type-badge type-${w.type.toLowerCase()}">${w.type} ${w.value}</span>`).join(', ') || '';
                lbElements.resistanceContainer.style.display = card.resistances?.length ? 'block' : 'none'; 
                lbElements.resistance.innerHTML = card.resistances?.map(r => `<span class="card-type-badge type-${r.type.toLowerCase()}">${r.type} ${r.value}</span>`).join(', ') || '';
                lbElements.retreatCostItem.style.display = card.retreatCost?.length ? 'block' : 'none';
                lbElements.retreatCost.innerHTML = card.retreatCost?.map(c => `<span class="energy-symbol energy-${c.toLowerCase()}">${c.charAt(0)}</span>`).join('') || '';
            }
            if(isTrainer){
                lbElements.trainerSubtypes.innerHTML = card.subtypes?.map(st => `<span class="card-type-badge type-trainer">${st}</span>`).join(' ') || '-';
                lbElements.rulesText.innerHTML = card.rules?.join('<br>') || '';
            }
            if(isEnergy){
                lbElements.energyTypes.innerHTML = card.types?.map(t => `<span class="card-type-badge type-${t.toLowerCase()}">${t}</span>`).join(' ') || '-';
                 lbElements.rulesText.innerHTML = card.rules?.join('<br>') || '';
            }
            lbElements.flavorText.textContent = card.flavorText || '-';
            lbElements.creator.textContent = card.forteData?.discordUsername || card.artist || 'Unknown';
            lbElements.isForte.innerHTML = card.forteData?.isForte ? '<span class="forte-badge" style="display:inline-flex; align-items:center; gap:0.25rem; background:var(--color-error); padding:0.2rem 0.4rem; border-radius:0.25rem; font-size:0.8rem;"><i class="fas fa-crown" style="font-size:0.7rem;"></i> Forte</span>' : 'No';
            lbElements.regulation.textContent = card.forteData?.regulationMark || '-';
            lbElements.approvedDate.textContent = card.forteData?.approvedDate || '-';
        }

        function updateLightboxNav() { 
            lightboxPrevBtn.disabled = currentLightboxIndex <= 0;
            lightboxNextBtn.disabled = currentLightboxIndex >= currentFilteredCardsForLightbox.length - 1;
        }
        function showPreviousCardInLightbox() { 
            if (currentLightboxIndex > 0) { currentLightboxIndex--; updateLightboxDetails(currentFilteredCardsForLightbox[currentLightboxIndex]); updateLightboxNav(); }
        }
        function showNextCardInLightbox() { 
            if (currentLightboxIndex < currentFilteredCardsForLightbox.length - 1) { currentLightboxIndex++; updateLightboxDetails(currentFilteredCardsForLightbox[currentLightboxIndex]); updateLightboxNav(); }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
   </script>
</body>
</html>
